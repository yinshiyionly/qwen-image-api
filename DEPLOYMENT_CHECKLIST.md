# 部署检查清单

本文档提供了 Qwen Image API Service 部署前、部署中和部署后的完整检查清单。

## 部署前检查

### 系统要求

- [ ] **硬件要求**
  - [ ] CPU: 4核以上（推荐8核）
  - [ ] 内存: 8GB以上（推荐16GB）
  - [ ] 存储: 50GB可用空间（推荐SSD 100GB）
  - [ ] GPU: NVIDIA RTX 3080或更高（可选，用于加速）

- [ ] **软件要求**
  - [ ] Docker 20.10+
  - [ ] Docker Compose 1.29+
  - [ ] NVIDIA Docker（如使用GPU）
  - [ ] 操作系统: Ubuntu 20.04+, CentOS 8+, 或其他兼容系统

### 环境准备

- [ ] **网络配置**
  - [ ] 端口8000可用（或配置其他端口）
  - [ ] 防火墙规则已配置
  - [ ] 域名解析已设置（生产环境）

- [ ] **文件和目录**
  - [ ] 项目代码已下载
  - [ ] 模型文件已准备（如有）
  - [ ] SSL证书已准备（生产环境）
  - [ ] 配置文件已准备

### 配置检查

- [ ] **基础配置**
  - [ ] `config.yaml` 文件已配置
  - [ ] `config.prod.yaml` 文件已配置（生产环境）
  - [ ] `.env` 文件已创建并配置
  - [ ] 模型路径已正确设置

- [ ] **安全配置**
  - [ ] API密钥已设置（生产环境）
  - [ ] 速率限制已配置
  - [ ] CORS设置已配置
  - [ ] SSL证书已配置（生产环境）

## 部署过程检查

### Docker 镜像构建

- [ ] **镜像构建**
  - [ ] Dockerfile 语法正确
  - [ ] 依赖安装成功
  - [ ] 镜像构建无错误
  - [ ] 镜像大小合理

```bash
# 检查命令
docker build -t qwen-image-api .
docker images | grep qwen-image-api
```

### 服务启动

- [ ] **容器启动**
  - [ ] Docker Compose 配置正确
  - [ ] 所有服务启动成功
  - [ ] 容器状态为 "Up"
  - [ ] 端口映射正确

```bash
# 检查命令
docker-compose up -d
docker-compose ps
docker port qwen-image-api
```

### 健康检查

- [ ] **服务健康**
  - [ ] 健康检查端点响应正常
  - [ ] 服务信息端点可访问
  - [ ] 日志无严重错误
  - [ ] 资源使用正常

```bash
# 检查命令
curl http://localhost:8000/health
curl http://localhost:8000/info
docker-compose logs qwen-image-api
docker stats qwen-image-api
```

## 部署后验证

### 功能测试

- [ ] **API 端点测试**
  - [ ] 健康检查: `GET /health`
  - [ ] 服务信息: `GET /info`
  - [ ] 文生图: `POST /text-to-image`
  - [ ] 图生图: `POST /image-to-image`（如有测试图片）

```bash
# 基础功能测试
curl -X POST "http://localhost:8000/text-to-image" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "测试图像", "width": 256, "height": 256}'
```

- [ ] **错误处理测试**
  - [ ] 无效请求返回适当错误
  - [ ] 超大文件上传被拒绝
  - [ ] 速率限制正常工作
  - [ ] 超时处理正确

### 性能测试

- [ ] **基础性能**
  - [ ] 单个请求响应时间合理
  - [ ] 并发请求处理正常
  - [ ] 内存使用稳定
  - [ ] CPU使用合理

```bash
# 简单负载测试
python tests/load_test.py
```

- [ ] **压力测试**
  - [ ] 高并发下服务稳定
  - [ ] 资源限制生效
  - [ ] 优雅降级工作
  - [ ] 恢复能力正常

### 监控和日志

- [ ] **日志系统**
  - [ ] 日志正常输出
  - [ ] 日志级别正确
  - [ ] 日志轮转工作
  - [ ] 错误日志可读

- [ ] **监控指标**
  - [ ] 指标端点可访问
  - [ ] 关键指标正常
  - [ ] 告警规则配置
  - [ ] 仪表板显示正常

## 生产环境额外检查

### 安全检查

- [ ] **网络安全**
  - [ ] HTTPS 配置正确
  - [ ] SSL 证书有效
  - [ ] 安全头设置正确
  - [ ] 不必要端口已关闭

- [ ] **访问控制**
  - [ ] API 密钥验证工作
  - [ ] 速率限制配置合理
  - [ ] IP 白名单配置（如需要）
  - [ ] 用户权限控制正确

### 高可用性

- [ ] **备份和恢复**
  - [ ] 数据备份策略已实施
  - [ ] 配置文件已备份
  - [ ] 恢复流程已测试
  - [ ] 备份存储安全

- [ ] **故障转移**
  - [ ] 多实例部署（如需要）
  - [ ] 负载均衡配置
  - [ ] 健康检查配置
  - [ ] 自动重启策略

### 运维准备

- [ ] **文档和流程**
  - [ ] 部署文档完整
  - [ ] 运维手册准备
  - [ ] 故障排除指南
  - [ ] 联系人信息更新

- [ ] **工具和脚本**
  - [ ] 管理脚本可用
  - [ ] 监控工具配置
  - [ ] 自动化脚本测试
  - [ ] 维护计划制定

## 部署验收标准

### 功能验收

- [ ] 所有API端点正常工作
- [ ] 图像生成质量符合预期
- [ ] 错误处理机制完善
- [ ] 文档和示例准确

### 性能验收

- [ ] 响应时间满足SLA要求
- [ ] 并发处理能力达标
- [ ] 资源使用在预期范围内
- [ ] 系统稳定性良好

### 安全验收

- [ ] 安全配置符合要求
- [ ] 访问控制正常工作
- [ ] 数据传输加密
- [ ] 审计日志完整

## 部署后维护

### 日常监控

- [ ] **系统监控**
  - [ ] 服务状态监控
  - [ ] 资源使用监控
  - [ ] 性能指标监控
  - [ ] 错误率监控

- [ ] **业务监控**
  - [ ] API调用量统计
  - [ ] 成功率监控
  - [ ] 用户行为分析
  - [ ] 业务指标跟踪

### 定期维护

- [ ] **系统更新**
  - [ ] 安全补丁更新
  - [ ] 依赖包更新
  - [ ] 配置优化
  - [ ] 性能调优

- [ ] **数据维护**
  - [ ] 日志清理
  - [ ] 缓存清理
  - [ ] 备份验证
  - [ ] 存储空间管理

## 回滚计划

### 回滚准备

- [ ] **备份验证**
  - [ ] 配置文件备份完整
  - [ ] 数据备份可用
  - [ ] 镜像版本标记
  - [ ] 回滚脚本准备

### 回滚执行

- [ ] **快速回滚**
  - [ ] 停止新版本服务
  - [ ] 恢复旧版本配置
  - [ ] 启动旧版本服务
  - [ ] 验证服务正常

```bash
# 回滚示例命令
docker-compose down
git checkout previous-version
docker-compose up -d
./scripts/manage.sh health
```

## 检查清单使用说明

1. **部署前**: 完成所有"部署前检查"项目
2. **部署中**: 按顺序执行"部署过程检查"
3. **部署后**: 进行全面的"部署后验证"
4. **生产环境**: 额外完成"生产环境额外检查"
5. **验收**: 确保满足所有"部署验收标准"
6. **维护**: 建立"部署后维护"流程

每个检查项目完成后，在对应的复选框中打勾 ✅。

如果某个检查项目失败，请参考 [故障排除指南](TROUBLESHOOTING.md) 进行问题解决。